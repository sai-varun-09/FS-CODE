*&---------------------------------------------------------------------*
*& Report ZV1_EVE_28
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT zv1_fs_report.


TYPES : BEGIN OF ty_final,
          matnr              TYPE mseg-matnr,
          werks              TYPE werks_d,
          charg              TYPE mseg-charg,
          lgort              TYPE mseg-lgort,
          maktx              TYPE makt-maktx,
          bwart              TYPE mseg-bwart,
          qlty_hold          TYPE qals-losmenge,
          blocked            TYPE qals-losmenge,
          quality_inspection TYPE qals-losmenge,
          unrestricted       TYPE qals-losmenge,
          uom                TYPE qals-mengeneinh,
        END OF ty_final.

DATA : lt_final TYPE TABLE OF ty_final,
       ls_final TYPE ty_final.

DATA : lv_matnr TYPE mseg-matnr,
       lv_werks TYPE mseg-werks,
       lv_charg TYPE mseg-charg,
       lv_lgort TYPE mseg-lgort.

SELECTION-SCREEN : BEGIN OF BLOCK b1 WITH FRAME TITLE TEXT-000.
  SELECT-OPTIONS : s_matnr FOR lv_matnr,
                   s_werks FOR lv_werks,
                   s_charg FOR lv_charg,
                   s_lgort FOR lv_lgort.
SELECTION-SCREEN : END OF BLOCK b1.

START-OF-SELECTION.


  SELECT matnr, maktx
    FROM makt
    INTO TABLE @DATA(lt_makt)
    WHERE matnr IN @s_matnr.

  IF lt_makt IS NOT INITIAL.


    SELECT matnr, werks, mblnr, charg, bwart, lgort
      FROM mseg
      INTO TABLE @DATA(lt_mseg)
      FOR ALL ENTRIES IN @lt_makt
      WHERE matnr = @lt_makt-matnr
        AND werks IN @s_werks
        AND charg IN @s_charg
        AND lgort IN @s_lgort.

    IF lt_mseg IS NOT INITIAL.


      SELECT prueflos, losmenge, mengeneinh, mblnr
        FROM qals
        INTO TABLE @DATA(lt_qals)
        FOR ALL ENTRIES IN @lt_mseg
        WHERE mblnr = @lt_mseg-mblnr
          AND charg IN @s_charg.

      IF lt_qals IS NOT INITIAL.


        SELECT prueflos, vcode
          FROM qave
          INTO TABLE @DATA(lt_qave)
          FOR ALL ENTRIES IN @lt_qals
          WHERE prueflos = @lt_qals-prueflos.

      ENDIF.
    ENDIF.
  ENDIF.


  LOOP AT lt_mseg INTO DATA(ls_mseg).

    CLEAR ls_final.

    ls_final-matnr = ls_mseg-matnr.
    ls_final-werks = ls_mseg-werks.
    ls_final-charg = ls_mseg-charg.
    ls_final-lgort = ls_mseg-lgort.
    ls_final-bwart = ls_mseg-bwart.


    READ TABLE lt_makt INTO DATA(ls_makt)
        WITH KEY matnr = ls_mseg-matnr.
    IF sy-subrc = 0.
      ls_final-maktx = ls_makt-maktx.
    ENDIF.


    READ TABLE lt_qals INTO DATA(ls_qals)
        WITH KEY mblnr = ls_mseg-mblnr.
    IF sy-subrc = 0.
      ls_final-uom = ls_qals-mengeneinh.
    ENDIF.

    READ TABLE lt_qave INTO DATA(ls_qave)
        WITH KEY prueflos = ls_qals-prueflos.
    IF sy-subrc = 0.
      CASE ls_qave-vcode.
        WHEN 'A'.
          ls_final-unrestricted = ls_qals-losmenge.
        WHEN 'QH'.
          ls_final-qlty_hold = ls_qals-losmenge.
        WHEN 'R'.
          ls_final-blocked = ls_qals-losmenge.
        WHEN OTHERS.
          ls_final-quality_inspection = ls_qals-losmenge.
      ENDCASE.
    ENDIF.

    APPEND ls_final TO lt_final.

  ENDLOOP.

  IF lt_final IS NOT INITIAL.
    cl_demo_output=>display( lt_final ).
  ELSE.
    WRITE: / 'No data found'.
  ENDIF.
